# Change log

## v1.8_dev1 - 2018-05-07

### added
* 4 checkpoints for saving session image - not only in case of tryCatch error (as this often did not work if the error occurred within a parallelised function or something like that

### fixed
* Remove FilterCells as it is inappropriate for deep sequenced data - should already have been done (deployed)

## v1.7 - 2018-05-03

### fixed
* EDIT_180421_7: changed control flow to catch cases where there are no PPI enriched modules (ensemblID was possibly producing an error by trying to print out a csv that didn't exist)
* EDIT_180421_8: fixed invalid length argument when diffParams_colors is NULL
    ~~pkMEs <- vector(mode="numeric",length=nrow(diffParams_colors))~~
    pkMEs <- vector(mode="numeric",length=length(list_colors_matched[[1]]))
* In RunPCA, set pcs.compute = min(nPC_seurat, nrow(seurat_obj_sub@data) %/% 2, ncol(seurat_obj_sub@data) %/% 2), rather than nrow-1, ncol-2, to avoid that IRLBA fails to converge or getting warnings that we are computing too large a proportion of singular components. If tryCatch catches a warning (from IRLBA) it calls RunPCA again with half the number of PCs to compute, fastpath = f, and maxit * 2.
 * If any subsets failed to produce modules, make an error log 
* Remove tryCatch in functions used in parallelisation as they may(?) cause problems
* Filtergenes seems to have been returning the original object! Fixed. 
* Filter out cells with >7000 genes (Seurat PBMC tutorial sets this at 5000); do not filter on UMI (previously removed cells with < 200 UMI)
* do regress out ribo 
* Major bug fix: remove the early mapping from symbol to Ensembl, while keeping symbols for unmapped genes. It led to a very confusing bug when the MAGMA part tried to map them again but only managed those that failed originally - apparently succeeding with some, however, leading to jumbled results.

### changed
* Comprehensive re-write of the parallelisation structure
* maps gene symbols to ensembl at the beginning rather than after finding modules; for unmapped genes, keeps the symbol
* EDIT 180421_9: added more rm() and gc()
* EDIT_180421_10: cl <- makeCluster(min(n_cores, detectCores()-1), type = "FORK")
* EDIT_180421_12 made sure that load_obj creates a new environment that does not inherit objects from the current one, and that the function removes everything from env afterwards
* makeCluster(outfile-..)
* JackStraw pcs.compute = ncol(seurat_obj_sub@dr$pca@gene.loadings))
  * Due to a bug in Jackstraw (https://github.com/satijalab/seurat/issues/277) use genes with high loading on a significant PC rather than genes with a significant loading on a significant PC. 
* EDIT 180428_1 : don't delete grey kME and kIM until preparing for output. This avoids confusion
* moved filterCellsScaleData into  the main script separated into the individual functions
* renamed wrapFilterGenes to just FilterGenes since there is no original function called that

### Added
* homo sapiens ensembl gene mapping
* EDIT 180425_1 MAGMA script now writes out csv as well as plots
* script now saves four session images as 'checkpoints' to resume in case of a crash
* Option to plot correlations between module cell embeddings and metadata - if factor, between each level
* plot kME-kIM correlations within each sub dataset - diagnostic plot to compare 
* plot kME - kME and kIM-kIM correlations across subsets
* 'resume' option starts computations from one of several checkpoints (e.g. in case the script failed or the user aborted)

## v1.6 - 2018-04-21

### Changed
* Updated readme.txt
*  EDIT_180421_5 if (anti_cor_action == "kME_reassign")  - not just if(!is.null(anti_cor_action
* wrapped magma script call in invisible()

### Fixed
* "kME_reassign_fnc: color**s**

## v1.5 - 2018-04-21

### Changed
* EDIT_180421_3  num.replicate for JackStraw is now a user parameter

### Fixed
* EDIT_180420_8 in FilterCells: 'subset.names', 'low.thresholds', and 'high.thresholds' must all have the same length 
* EDIT_180421_1 removed ~~list_reassigned~~
* EDIT_180421_2 rm(list_list_kME_reassign_in, )

## v1.4 - 2018-04-20

### Changed
* Reintroduced cell filtering based on mito
* Set nPC_seurat, i.e. PCs to calculate, from 75 to 200
* Increased RunPCA maxit parameter for IRLBA from 300 to 1000
* Edit_180420_2 set jackstraw num.replicate from 100 to 1000 (as recommended in Seurat tutorial)
* EDIT_180420_3: if genes_use == "PCA", select genes that load significantly on significant PCs
* EDIT_180420_5: remove hvg option - since hvg just ranks all genes, it only makes sense if we set a number cutoff (and its probably not a good way to pick genes)
Rename plot labels to plot_labels
* Do MAGMA for modules also w/o PPI enrichment filtering

### Fixed 
* kME reassign: make sure old_colors declared before if statement
* Rather than nPC_seurat, use npc.compute (the actual number of PCs computed by RunPCA, given the size of the matrix) downstream. Could lead to problems if nPC_seurat > pcs.compute
* parMagma: renamed dir_tables tables_dir

## v1.3 - 2018-04-20

### fixed
* Plotting error due to giving wrong arguments
* for plotting colors: use matrix rather than as.matrix
* corrected references to list_colors instead of list_colors_matched

### Added
* For testing changes: added save.image checkpoints 
* tryCatch now saves session image to file in case of error

## v1.2 - 2018-04-19

### Changed
* to compare parameters, allow user to input vectors as default for cutreeHybrid parameters. Adapted user input checks accordingly. The script is now built to get multiple parameters without a conditional flow distinguishing betwen a single or multiple sets of parameters. The script is much simplified.
* In compare_params, use number of genes assigned to non-grey modules after filtering for Protein-Protein-Interaction fdr p-value as statistic to choose best parameters
* Reverted back to RunPCA weight.by.var = F. I guess it also affects the gene loadings a lot - to be tested
* increase scale free topology powers to 1:30
*MEs now consistently holds merged$MEGs - so we have to extract the eigengenes with MEs$eigengenes
* delete grey kMEs in each set in list_kMEs in compare_params loop 
* if (length(unique(cutree$labels)) > 1) { ...
* Set nPC_seurat to 75
* Moved plot_permuted below the compare_params part
* kME_reassign is now done in a function
* extract_and_name_colors now done in a function
* parMagma: outputs to same folder as WGCNA project; aligned output names
* parMagma: loops over subdirectories within magma_gwas_dir and does separate analysis on each
*parMagma: commented out labeledHeatmap
* plot file names now have flag_date at the end
* renamed all data path variables
* Moved input data checks to their own section

### Added
* min.cells user parameter for filtering genes
* if file.exists... to remove seurat subsets
* log_dir

### Removed
* tryCatch() around compare_modules (too big)
* names(pkMEs_PPI) <- names(colors_PPI)
* names(pkMEs) <- names(colors)      
* save_plots parameter
* Removed PC significance JackStraw test for selecting genes based on loadings - doesn't produce better results

## Fixed
* Removed FilterCells step - in Campbell AgRP neurons, max genes 5000 was removing half of the neurons, from 2233 to 1274. Likely had enormous impact on results. softPower indices were very much affected.
* bootstrap(replace=T) returns the original dataset plus the desired number of permutated sets rather than the desired number minus one.  In if (plot_permuted == T) chunk, fixed indiv_TOMS <- lapply ... which was also off by one.
*  for (j in 1:length(list_MEs)) { : nested loop used same index 'j' as outer - now k
* in matchLabels, extraLabels = standardColors()

## v1.1 - 2018-04-17

### Fixed
* plot_permuted loop: fixed mapply (removed inappropriate schedule argument)
* coerce goodGenesTOM_idx to logical (was character)


## v1.0 - 2018-04-17

###  Fixed
* MAGMA parallel loop call now loads Matrix and also gets explicit arguments. Tested and works

## v0.9 - 2018-04-16

### Added
* For kME_reassign, save csv file with list of genes moved,  respective modules and pkMEs
* Allow user to specify meta.data_ID to use for subsetting Seurat object

### Fixed
* Made MAGMA a separate parallel loop to reduce concurrent libraries loaded onto each cluster in parallel processing to avoid crashing worker sessions

##v0.8 - 2018-04-13

### Changed
* Set kME_reassign_threshold in params to 1.5 (conservative)
* In the for loop the full list of subsets is now loaded into and removed from memory in each iteration. Slower but much more memory efficient.
* save.image for each iteration rather than an (unwieldy) list of objects
* reintroduced parLapply in MAGMA
* parallelised the whole script since it is now much more memory efficient than before

### Fixed
* kMEs$kMEgrey <- NULL would use tab completion to set kMEs$kMEgrey60 to NULL. Hence changed to kMEs[['kMEgrey']] <- NULL
* STRINGdb loop is now robust (tryCatch within for loop)

## v0.7 - 2018-04-12

### Added
* More messages throughout
* Check genes_use argument
* remove grey module kMEs from output
  
### changed
* Declare `PPI_pval_threshold` in `rwgcna_params.R`
* reverted MAGMA step to lapply to reduce risk of errors (seems unnecessary)
* Rather than choosing scale_data or not, now choose do.center or not (for bicor). Data is in either case scaled and nUMI and percent.mito regressed out.
* moduleEigengenes(...excludegrey = T)

### Removed
* Redundant parameters minModuleSize, deepSplit and nPermutations from built in parameters csv file

### Fixed 
* conditional flow around FilterCells and ScaleData
* removed conditional around ScaleData which would skip the step if scale_data = F. Scale data used for PCA which we use to select genes. Hence if we skip data scaling on the subset, it would actually just use the scaled data already in the seurat_object which would lead to poor PCA and selection of top loading genes - or code failure.
* set do.center = T always to avoid messing up PCA calculations. Instead make bicor == T -> scale_data <- F
* removed grey module from kMEs and kMEs_PPI

## v0.6 - 2018-04-10

### Added
* filter out genes with few cells
* filter cells with mito > 0.2
* do not filter for ribo

### Changed
* scale.data = F
* Seurat: if (scale_data == T) scale, regress out
* Seurat: if (genes_use != "all") ..find variable genes, runPCA
 * FindVariableGenes
 * delete mean.function = ExpMean,
 * delete dispersion.function = LogVMR,
    RunPCA
        Increase nPC_Seurat from 40 to 100 (for RunPCA() )
        seed.use = randomSeed __instead of default value of 42__
        Set fastpath = FALSE
        Set maxit = 300 
    findSoftThreshold
        powers: max softPower values to check up from 12 to 20
    moduleEigengenes 
        excludeGrey = T
        #softpower = softPower
        The power used in soft-thresholding the adjacency matrix. Only used when the hubgene approximation is necessary because the principal component calculation failed. It must be non-negative. The default value should only be changed if there is a clear indication that it leads to incorrect results.
    consensusTOM
        delete checkPower = checkPower - __This was not defined?__
    Move wgcna_params.R to same folder
    
__beginning of change log__

